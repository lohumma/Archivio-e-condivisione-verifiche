<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Quiz | 6 FALCHI LEONARDO</title>
  <style>
    :root {
      --bg: #ffffff;
      --panel: #ffffff;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --accent: #1d4ed8;
      --accent-2: #0ea5e9;
      --border: #5a3f2f;
      --success: #16a34a;
      --danger: #dc2626;
      --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Trebuchet MS", "Segoe UI", system-ui, sans-serif;
      margin: 0;
      color: var(--text);
      background: #ffffff;
    }
    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 28px 20px 90px;
    }
    h2 { margin: 0 0 12px; letter-spacing: 0.4px; }
    .hidden { display: none !important; }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
    }
    .intro-box {
      background: #f1f5f9;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      color: var(--text);
    }
    .question {
      font-weight: 700;
      font-size: 18px;
      margin: 4px 0 12px;
    }
    .option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      margin: 8px 0;
    }
    .option input { transform: scale(1.1); }
    .indicators { display: flex; flex-wrap: wrap; gap: 6px; }
    .indicators button {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      font-weight: 700;
      cursor: pointer;
    }
    .green { background: #dbeafe; color: #0f172a; }
    .red { background: #fee2e2; color: #111827; }
    button {
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
    }
    button:hover { border-color: #5a3f2f; }
    .btn-primary {
      background: #e0f2fe;
      color: #0f172a;
      border: 1px solid #bae6fd;
    }
    .noselect, .noselect *:not(input):not(textarea):not(select) { user-select: none; }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      padding: 16px;
    }
    .finish-bar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      padding: 12px;
      background: #ffffff;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: center;
      gap: 12px;
      z-index: 5;
    }
    .modal {
      background: #ffffff;
      border: 1px solid var(--border);
      padding: 20px;
      border-radius: 14px;
      max-width: 520px;
      width: 100%;
      box-shadow: var(--shadow);
      text-align: center;
    }
    .modal button { margin: 8px; padding: 10px 16px; }
    .btn-success { background: #dcfce7; color: #14532d; border: 1px solid #bbf7d0; }
    .status { margin-top: 10px; font-weight: 700; color: #0f172a; }
    .success-gif { margin-top: 8px; max-width: 140px; width: 100%; height: auto; }
    .warning-gif { margin: 8px auto 4px; max-width: 160px; width: 100%; height: auto; display: block; }
    .btn-finish { background: #1d4ed8; color: #ffffff; border: 1px solid #1e3a8a; }
    textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 10px;
      resize: vertical;
    }
  </style>
</head>
<body class="noselect">
  <div class="page">
  <h2 id="pageTitle">Compito di Tecnologie_dei_processi_di_produzione</h2>
  <div id="intro" class="card">
    <p><strong>Studente:</strong> 6 FALCHI LEONARDO</p>
    <p><strong>Classe:</strong> 4 BGC</p>
    <p><label><input type="checkbox" id="riduzioneTempo"  disabled> Riduzione o tempo aggiuntivo</label></p>
    <div class="intro-box">
      <strong>Regole del test:</strong>
      <ul style="margin:8px 0 0 18px; padding:0;">
        <li>ACCERTATI DI APRIRE IL FILE HTML CON GOOGLE CHROME.</li>
        <li>Una volta avviato il test, entri in modalita fullscreen. Non uscire MAI dalla modalita fullscreen o ricevi un ammonimento. Al secondo ammonimento il test si conclude automaticamente e consegni il documento.</li>
        <li>Se apri un'altra scheda, aggiorni la pagina o riduci a icona il test, ricevi un ammonimento; al secondo ammonimento il test si conclude automaticamente e devi consegnere il documento.</li>
        <li>Una volta concluso il test, il file JSON verr� consegnato automaticamente al docente.</li>
        <li>Quando hai finito il test, avverti il docente alzando la mano.</li>
      </ul>
    </div>
    <button class="btn-primary" onclick="startQuiz()">Inizia quiz</button>
  </div>

  <div id="quiz" class="hidden card">
    <div class="question" id="questionText"></div>
    <div id="options"></div>
    <div style="height:12px;"></div>
    <div style="display:flex; gap:10px; margin:12px 0;">
      <button onclick="prev()">&lt;&lt; Precedente</button>
      <button onclick="next()">Successiva &gt;&gt;</button>
    </div>
    <div style="height:12px;"></div>
    <div class="indicators" id="indicators" style="margin-bottom:14px;"></div>
    <div class="finish-bar">
      <button class="btn-finish" onclick="finishQuiz()" style="padding:12px 18px; font-size:16px;">Completa e chiudi il test</button>
    </div>
  </div>
  </div>
  <div id="confirmFinishOverlay" class="hidden overlay">
    <div class="modal">
      <p>Sicuro di voler consegnare?</p>
      <div>
        <button onclick="confirmFinish()" class="btn-success">Completa</button>
        <button onclick="cancelFinish()">Annulla</button>
      </div>
    </div>
  </div>
  <div id="warningOverlay" class="hidden overlay">
    <div class="modal">
      <p>Non rimuovere la modalita Fullscreen, alla prossima consegnerai il compito.</p>
      <div>
        <img class="warning-gif" alt="Ammonizione fullscreen" src="../../../../../../../Archivio-e-condivisione-verifiche/0.%20Immagini%20template%20quiz/Ammonizione%20fullscreen.gif">
        <button onclick="confirmWarning()" class="btn-success">OK</button>
      </div>
    </div>
  </div>
  <div id="downloadOverlay" class="hidden overlay">
    <div class="modal">
      <p>Consegna il quiz al docente.</p>
      <div>
        <button id="downloadZipBtn" onclick="submitDelivery()">Consegna</button>
      </div>
      <div id="downloadStatus" class="status"></div>
      <img id="successGif" class="success-gif hidden" alt="Invio completato" src="../../../../../../../Archivio-e-condivisione-verifiche/0.%20Immagini%20template%20quiz/Invio%20completato.gif">
    </div>
  </div>

  <script>
    const allQuestions = [{"qid":"qa1","qhash":"1depr0i","question":"Spiega il funzionamento di base della blockchain.","open":true},{"qid":"qa2","qhash":"1d4q5bj","question":"Qual è la funzione della crittografia?","open":true},{"qid":"qa3","qhash":"1cuqjmk","question":"Cosa si intende per \"latenza\".","open":true},{"qid":"qa4","qhash":"1ckqxxl","question":"Spiega i rischi e le opportunità del metaverso dal punto di vista sociale ed economico.","open":true},{"qid":"qa5","qhash":"1carc8m","question":"Elenca e spiega gli elementi tecnologici necessari allo sviluppo del metaverso.","open":true},{"qid":"q6","qhash":"16j9eji","question":"Che cosa ha supplito alle attività in presenza durante la pandemia?","options":[{"id":"o61","hash":"1w3s8h7","t":"Solo i social network"},{"id":"o62","hash":"1wdru66","t":"Teleconferenze, didattica a distanza e telelavoro"},{"id":"o63","hash":"1wnrfv5","t":"La televisione"},{"id":"o64","hash":"1wxr1k4","t":"La stampa"}],"correctHash":"cyq47k"},{"qid":"q7","qhash":"16t908h","question":"Qual è la funzione principale del marketing?","options":[{"id":"o71","hash":"xpavke","t":"Vendere direttamente un prodotto"},{"id":"o72","hash":"xfb9vf","t":"Identificare i bisogni delle persone e trovare il modo migliore per soddisfarli"},{"id":"o73","hash":"x5bo6g","t":"Creare slogan pubblicitari"},{"id":"o74","hash":"z38w19","t":"Gestire solo la comunicazione visiva"}],"correctHash":"1lycpru"},{"qid":"q8","qhash":"14vbsdo","question":"Qual è definita come la vera ricchezza del XXI secolo?","options":[{"id":"o81","hash":"1srqp5l","t":"L’oro"},{"id":"o82","hash":"1rxrw2o","t":"Le informazioni"},{"id":"o83","hash":"1s7rhrn","t":"L’energia"},{"id":"o84","hash":"1tlpi8i","t":"Il territorio"}],"correctHash":"1wwkdgg"},{"qid":"q9","qhash":"155be2n","question":"Il termine metaverso indica:","options":[{"id":"o91","hash":"1tvs9fg","t":"Un nuovo social network"},{"id":"o92","hash":"1upr2id","t":"Un universo oltre quello fisico"},{"id":"o93","hash":"1ufrgte","t":"Un software di montaggio"},{"id":"o94","hash":"1t1tgcj","t":"Un videogioco specifico"}],"correctHash":"10teu5i"},{"qid":"q10","qhash":"1dtc5wl","question":"Chi ha usato per primo il termine metaverso nel 1992?","options":[{"id":"o101","hash":"1dlpshe","t":"Philip Kotler"},{"id":"o102","hash":"1dbq6sf","t":"Neal Stephenson"},{"id":"o103","hash":"1d1ql3g","t":"Mark Zuckerberg"},{"id":"o104","hash":"1crqzeh","t":"Satoshi Nakamoto"}],"correctHash":"1y0k3lg"},{"qid":"q11","qhash":"1djck7m","question":"Quale evento ha accelerato l’uso delle piattaforme digitali?","options":[{"id":"o111","hash":"1cho87j","t":"La crisi economica del 2008"},{"id":"o112","hash":"1crntwi","t":"La pandemia da Covid-19"},{"id":"o113","hash":"1d1nflh","t":"La nascita dei social"},{"id":"o114","hash":"1b3q7qo","t":"L’avvento degli smartphone"}],"correctHash":"b39juo"},{"qid":"q12","qhash":"1d9cyin","question":"Che cosa garantisce oggi maggiormente la qualità di un prodotto o servizio?","options":[{"id":"o121","hash":"hf8emc","t":"La pubblicità televisiva"},{"id":"o122","hash":"i977p9","t":"Il passaparola sui social media"},{"id":"o123","hash":"hz7m0a","t":"Il prezzo elevato"},{"id":"o124","hash":"gl9ljf","t":"Il marchio storico"}],"correctHash":"pg07g4"},{"qid":"q13","qhash":"1czdcto","question":"Con l’avvento di internet, le aziende hanno affiancato ai media tradizionali:","options":[{"id":"o131","hash":"gb6uch","t":"Solo la televisione satellitare"},{"id":"o132","hash":"fh819k","t":"I nuovi media nati con la rete"},{"id":"o133","hash":"fr7myj","t":"Esclusivamente i videogiochi"},{"id":"o134","hash":"h55nfe","t":"Unicamente le app proprietarie"}],"correctHash":"z4iii0"},{"qid":"q14","qhash":"1cpdr4p","question":"Il marketing digitale applica strategie comunicative principalmente su:","options":[{"id":"o141","hash":"gaov8u","t":"Supporti cartacei"},{"id":"o142","hash":"g0p9jv","t":"Dispositivi digitali"},{"id":"o143","hash":"fqpnuw","t":"Eventi dal vivo"},{"id":"o144","hash":"homvpp","t":"Canali radiofonici"}],"correctHash":"6p1umc"},{"qid":"q15","qhash":"1cfe5fq","question":"La pubblicità (advertising) viene descritta come:","options":[{"id":"o151","hash":"f6nayz","t":"Sinonimo di marketing"},{"id":"o152","hash":"fgmwny","t":"Una componente del marketing"},{"id":"o153","hash":"fqmicx","t":"Un’attività indipendente dal marketing"},{"id":"o154","hash":"g0m41w","t":"Una pratica esclusivamente digitale"}],"correctHash":"1o38zew"},{"qid":"q16","qhash":"1c5ejqr","question":"Cosa intendiamo quando parliamo di PPD?","options":[{"id":"o161","hash":"1a9o95s","t":"Pixel Per Grado"},{"id":"o162","hash":"1b3n28p","t":"Nessuna delle altre risposte"},{"id":"o163","hash":"1atngjq","t":"Pixel Per Densità"},{"id":"o164","hash":"1bnm9mn","t":"Pixel per durata"}],"correctHash":"i5e3tp"},{"qid":"q17","qhash":"1bvey1s","question":"Perché le aziende utilizzano i social media nel marketing?","options":[{"id":"o171","hash":"iioual","t":"Perché sono gratuiti"},{"id":"o172","hash":"hoq17o","t":"Perché gli utenti vi trascorrono molto tempo"},{"id":"o173","hash":"hypmwn","t":"Perché sostituiscono i prodotti"},{"id":"o174","hash":"h4qttq","t":"Perché eliminano la concorrenza"}],"correctHash":"1d59400"},{"qid":"q18","qhash":"1g18zgd","question":"Che cosa significa gamification?","options":[{"id":"o181","hash":"1i0rzze","t":"Eliminare il gioco"},{"id":"o182","hash":"1hqseaf","t":"Usare il gioco come leva motivazionale"},{"id":"o183","hash":"1hgsslg","t":"Sostituire il marketing"},{"id":"o184","hash":"1h6t6wh","t":"Creare videogiochi"}],"correctHash":"1xrdois"},{"qid":"q19","qhash":"1fr9dre","question":"Perché il sistema dei social viene definito bidirezionale e non democratico?","options":[{"id":"o191","hash":"1gwqfpj","t":"Perché tutti hanno gli stessi diritti"},{"id":"o192","hash":"1h6q1ei","t":"Perché opera su piattaforme proprietarie"},{"id":"o193","hash":"1hgpn3h","t":"Perché non permette commenti"},{"id":"o194","hash":"1fisf8o","t":"Perché è anonimo"}],"correctHash":"159ux0g"},{"qid":"q20","qhash":"1fhcxke","question":"Qual è una delle principali motivazioni economiche dietro lo sviluppo del metaverso?","options":[{"id":"o201","hash":"xkn3rr","t":"Ridurre i costi energetici"},{"id":"o202","hash":"xumpgq","t":"Creare un nuovo grande mercato"},{"id":"o203","hash":"y4mb5p","t":"Eliminare la concorrenza"},{"id":"o204","hash":"w6p3aw","t":"Sostituire il lavoro umano"}],"correctHash":"6x415c"}];
    const safeName = (str) => String(str || "").trim().replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "");
    const hashToken = (str) => String(str || "").trim().replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "");
    const hashId = (value) => {
      const str = String(value || "");
      let hash = 2166136261;
      for (let i = 0; i < str.length; i++) {
        hash ^= str.charCodeAt(i);
        hash = Math.imul(hash, 16777619);
      }
      return (hash >>> 0).toString(36);
    };
    const hashJoin = (qid, oid) => hashId(qid + "+" + oid);
    const studentLabel = "6 FALCHI LEONARDO";
    const studentReg = "6";
    const studentSurname = "FALCHI";
    const studentName = "LEONARDO";
    const materiaLabel = "Tecnologie_dei_processi_di_produzione";
    const classeLabel = "4 BGC";
    const topicLabel = "Social_media_e_metaverso";
    const uploadOnly = true;
    const generatedDate = new Date().toLocaleDateString("it-IT");
    let current = 0;
    const answers = {};
    const questionText = document.getElementById('questionText');
    const optionsEl = document.getElementById('options');
    const indicators = document.getElementById('indicators');
    const quizEl = document.getElementById('quiz');
    const introEl = document.getElementById('intro');
    const confirmOverlay = document.getElementById('confirmFinishOverlay');
    const warningOverlay = document.getElementById('warningOverlay');
    const overlay = document.getElementById('downloadOverlay');
    const downloadStatus = document.getElementById('downloadStatus');
    const successGif = document.getElementById('successGif');

    let finishAsked = false;
    let fullscreenExits = 0;
    let warningActive = false;
    function requestFull() {
      const el = document.documentElement;
      const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
      if (fn) {
        fn.call(el).catch(() => {});
      }
    }

    function renderQuestion() {
      const q = allQuestions[current];
      questionText.textContent = (current + 1) + '. ' + q.question;
      optionsEl.innerHTML = '';
      if (q.open) {
        const ta = document.createElement('textarea');
        ta.rows = 4;
        ta.style.width = '100%';
        ta.value = answers[q.qid] || '';
        ta.addEventListener('input', () => answers[q.qid] = ta.value);
        optionsEl.appendChild(ta);
      } else {
        const letter = (i) => String.fromCharCode(65 + i);
        q.options.forEach((opt, idx) => {
          const lbl = document.createElement('label');
          lbl.className = 'option';
          const inp = document.createElement('input');
          inp.type = 'radio';
          inp.name = 'opt';
          inp.value = opt.id;
          inp.checked = answers[q.qid] === opt.id;
          inp.addEventListener('change', () => answers[q.qid] = opt.id);
          lbl.appendChild(inp);
          lbl.append(' ' + letter(idx) + '. ' + opt.t);
          optionsEl.appendChild(lbl);
        });
      }
      renderIndicators();
    }

    function renderIndicators() {
      indicators.innerHTML = '';
      allQuestions.forEach((q, idx) => {
        const b = document.createElement('button');
        b.textContent = idx + 1;
        b.className = answers[q.qid] ? 'green' : '';
        b.onclick = () => { current = idx; renderQuestion(); };
        indicators.appendChild(b);
      });
    }

    function startQuiz() {
      introEl.classList.add('hidden');
      quizEl.classList.remove('hidden');
      requestFull();
      renderQuestion();
    }
    function next() { if (current < allQuestions.length - 1) { current++; renderQuestion(); } }
    function prev() { if (current > 0) { current--; renderQuestion(); } }

    function finishQuiz() {
      confirmOverlay.classList.remove('hidden');
    }

    function cancelFinish() {
      confirmOverlay.classList.add('hidden');
    }

    function confirmFinish() {
      finishAsked = true;
      confirmOverlay.classList.add('hidden');
      quizEl.classList.add('hidden');
      overlay.classList.remove('hidden');
    }

    function buildJsonPayload() {
      const letter = (i) => String.fromCharCode(65 + i);
      const payloadDomande = allQuestions.map((q, idx) => {
        if (q.open) {
          return {
            tipo: "aperta",
            domanda: q.question,
            risposta: answers[q.qid] || ""
          };
        }
        const opts = (q.options || []).map((o, i) => ({
          id: o.id,
          testo: o.t,
          lettera: letter(i)
        }));
        const correctHash = q.correctHash;
        const userId = answers[q.qid];
        const correctOpt = opts.find(o => hashJoin(q.qid, o.id) === correctHash);
        const userOpt = opts.find(o => o.id === userId);
        return {
          tipo: "chiusa",
          domanda: q.question,
          opzioni: opts,
          risposta_corretta: correctOpt ? (correctOpt.lettera + ". " + correctOpt.testo) : "",
          risposta_data: userOpt ? (userOpt.lettera + ". " + userOpt.testo) : ""
        };
      });
      const out = {
        studente: studentLabel,
        classe: classeLabel,
        materia: materiaLabel,
        argomento: topicLabel,
        data: generatedDate,
        domande: payloadDomande
      };
      return out;
    }

    
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwWjGBJzIKSQWy9pCLp0OQJbVM971yY2ldN9rNHKGAscx9B4DkSfcdOeYgpQO2yOXAi/exec";
    const PIN = "PIN123";

    async function consegnaQuiz(quizJson, quizId, studente) {
      const payload = {
        pin: PIN,
        quiz_id: quizId,
        studente: studente,
        payload: quizJson
      };
      const body = new URLSearchParams();
      body.set("data", JSON.stringify(payload));
      const res = await fetch(WEBAPP_URL, { method: "POST", body });
      const text = await res.text();
      console.log("Server:", text);
      alert("Consegna inviata!");
    }

    async function submitDelivery() {
      try {
        downloadStatus.textContent = "Attendi l'invio del file...";
        const quizJson = buildJsonPayload();
        const quizId = "illuminazione_01";
        const studente = new URLSearchParams(location.search).get("token") || "anonimo";
        await consegnaQuiz(quizJson, quizId, studente);
        downloadStatus.textContent = "Consegna inviata.";
        if (successGif) successGif.classList.remove('hidden');
      } catch (err) {
        console.error(err);
        downloadStatus.textContent = "Errore invio consegna.";
      }
    }
    

    document.addEventListener('fullscreenchange', () => {
      const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
      if (!isFs) {
        fullscreenExits += 1;
        if (fullscreenExits === 1) {
          warningActive = true;
          warningOverlay.classList.remove('hidden');
        } else {
          finishAsked = true;
          quizEl.classList.add('hidden');
          overlay.classList.remove('hidden');
          submitDelivery();
        }
      }
    });

    function confirmWarning() {
      warningOverlay.classList.add('hidden');
      warningActive = false;
      quizEl.classList.remove('hidden');
      requestFull();
    }

    window.addEventListener('load', () => {
      requestFull();
    });
  </script>
</body>
</html>
