<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Quiz | 21 SICONOLFI MELISSA</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; }
    .hidden { display: none !important; }
    .question { font-weight: bold; margin-top: 20px; }
    .option { display: block; margin: 6px 0; }
    .indicators button { width: 30px; margin: 2px; }
    .green { background: palegreen; }
    .red { background: lightcoral; }
    .noselect, .noselect *:not(input):not(textarea):not(select) { user-select: none; }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.55); display: flex; align-items: center; justify-content: center; z-index: 999; }
    .modal { background: #fff; padding: 20px; border-radius: 8px; max-width: 480px; width: 90%; box-shadow: 0 8px 24px rgba(0,0,0,0.2); text-align: center; }
    .modal button { margin: 8px; padding: 10px 16px; }
    .btn-success { background: palegreen; }
    .status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body class="noselect">
  <h2 id="pageTitle">Compito di Laboratori Tecnici</h2>
  <div id="intro">
    <p><strong>Studente:</strong> 21 SICONOLFI MELISSA</p>
    <p><strong>Classe:</strong> 3 BGC</p>
    <p><label><input type="checkbox" id="riduzioneTempo"  disabled> Riduzione o tempo aggiuntivo</label></p>
    <div style="margin:12px 0; padding:12px; border:1px solid #cbd5e1; border-radius:6px; background:#f1f5f9; color:#0f172a;">
      <strong>Regole del test:</strong>
      <ul style="margin:8px 0 0 18px; padding:0;">
        <li>ACCERTATI DI APRIRE IL FILE HTML CON GOOGLE CHROME.</li>
        <li>Una volta avviato il test, entri in modalita fullscreen. Non uscire MAI dalla modalita fullscreen o ricevi un ammonimento. Al secondo ammonimento il test si conclude automaticamente e consegni il documento.</li>
        <li>Se apri un'altra scheda, aggiorni la pagina o riduci a icona il test, ricevi un ammonimento; al secondo ammonimento il test si conclude automaticamente e devi consegnere il documento.</li>
        <li>Una volta concluso il test, il file JSON verr√† consegnato automaticamente al docente.</li>
        <li>Quando hai finito il test, avverti il docente alzando la mano.</li>
      </ul>
    </div>
    <button onclick="startQuiz()">Inizia quiz</button>
  </div>

  <div id="quiz" class="hidden">
    <div class="question" id="questionText"></div>
    <div id="options"></div>
    <div style="height:12px;"></div>
    <div style="display:flex; gap:10px; margin:12px 0;">
      <button onclick="prev()">&lt;&lt; Precedente</button>
      <button onclick="next()">Successiva &gt;&gt;</button>
    </div>
    <div style="height:12px;"></div>
    <div class="indicators" id="indicators" style="margin-bottom:14px;"></div>
    <div style="display:flex; justify-content:center; gap:12px; margin:16px 0;">
      <button onclick="finishQuiz()" style="padding:12px 18px; font-size:16px;">Completa e chiudi il test</button>
    </div>
  </div>
  <div id="downloadOverlay" class="hidden overlay">
    <div class="modal">
      <p>Consegna il quiz al docente.</p>
      <div>
        <button id="downloadZipBtn" onclick="submitDelivery()">Consegna</button>
      </div>
      <div id="downloadStatus" class="status"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const allQuestions = [{"qid":"q1","qhash":"17d87mf","question":"aa","options":[{"id":"o11","hash":"1ycdc4k","t":"1"},{"id":"o12","hash":"5838d","t":"2"},{"id":"o13","hash":"1ywcjii","t":"3"},{"id":"o14","hash":"1xiej1n","t":"4"}],"correctHash":"eajksm"}];
    const safeName = (str) => String(str || "").trim().replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "");
    const hashToken = (str) => String(str || "").trim().replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "");
    const hashId = (value) => {
      const str = String(value || "");
      let hash = 2166136261;
      for (let i = 0; i < str.length; i++) {
        hash ^= str.charCodeAt(i);
        hash = Math.imul(hash, 16777619);
      }
      return (hash >>> 0).toString(36);
    };
    const hashJoin = (qid, oid) => hashId(qid + "+" + oid);
    const studentLabel = "21 SICONOLFI MELISSA";
    const studentReg = "21";
    const studentSurname = "SICONOLFI";
    const studentName = "MELISSA";
    const materiaLabel = "Laboratori Tecnici";
    const classeLabel = "3 BGC";
    const topicLabel = "11a";
    const uploadOnly = true;
    const generatedDate = new Date().toLocaleDateString("it-IT");
    let current = 0;
    const answers = {};
    const questionText = document.getElementById('questionText');
    const optionsEl = document.getElementById('options');
    const indicators = document.getElementById('indicators');
    const quizEl = document.getElementById('quiz');
    const introEl = document.getElementById('intro');
    const overlay = document.getElementById('downloadOverlay');
    const downloadStatus = document.getElementById('downloadStatus');

    let finishAsked = false;
    let downloadedFiles = false;

    function requestFull() {
      const el = document.documentElement;
      const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.mozRequestFullScreen || el.msRequestFullscreen;
      if (fn) {
        fn.call(el).catch(() => {});
      }
    }

    function renderQuestion() {
      const q = allQuestions[current];
      questionText.textContent = (current + 1) + '. ' + q.question;
      optionsEl.innerHTML = '';
      if (q.open) {
        const ta = document.createElement('textarea');
        ta.rows = 4;
        ta.style.width = '100%';
        ta.value = answers[q.qid] || '';
        ta.addEventListener('input', () => answers[q.qid] = ta.value);
        optionsEl.appendChild(ta);
      } else {
        const letter = (i) => String.fromCharCode(65 + i);
        q.options.forEach((opt, idx) => {
          const lbl = document.createElement('label');
          lbl.className = 'option';
          const inp = document.createElement('input');
          inp.type = 'radio';
          inp.name = 'opt';
          inp.value = opt.id;
          inp.checked = answers[q.qid] === opt.id;
          inp.addEventListener('change', () => answers[q.qid] = opt.id);
          lbl.appendChild(inp);
          lbl.append(' ' + letter(idx) + '. ' + opt.t);
          optionsEl.appendChild(lbl);
        });
      }
      renderIndicators();
    }

    function renderIndicators() {
      indicators.innerHTML = '';
      allQuestions.forEach((q, idx) => {
        const b = document.createElement('button');
        b.textContent = idx + 1;
        b.className = answers[q.qid] ? 'green' : '';
        b.onclick = () => { current = idx; renderQuestion(); };
        indicators.appendChild(b);
      });
    }

    function startQuiz() {
      introEl.classList.add('hidden');
      quizEl.classList.remove('hidden');
      requestFull();
      renderQuestion();
    }
    function next() { if (current < allQuestions.length - 1) { current++; renderQuestion(); } }
    function prev() { if (current > 0) { current--; renderQuestion(); } }

    function finishQuiz() {
      finishAsked = true;
      quizEl.classList.add('hidden');
      overlay.classList.remove('hidden');
    }

    function buildPdfBlob() {
      const jsPdfFactory = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF || null;
      if (!jsPdfFactory) {
        alert("Libreria jsPDF non caricata. Impossibile generare il PDF.");
        return null;
      }
      const doc = new jsPdfFactory();
      const margin = 20; // 2 cm
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const maxWidth = pageWidth - margin * 2;
      const bottomLimit = () => pageHeight - margin;
      const lineH = 6;
      const letter = (i) => String.fromCharCode(65 + i);
      const colors = {
        primary: [18, 91, 190],
        section: [205, 221, 248],
        text: [15, 30, 60],
        muted: [90, 110, 140]
      };
      let y = margin;
      const ensurePage = (extra = 0) => {
        if (y + extra > bottomLimit()) {
          doc.addPage();
          y = margin;
        }
      };
      const writeLines = (text, opts = {}) => {
        const { indent = 0, font = "normal", size = 11, color = [0,0,0] } = opts;
        doc.setFont("helvetica", font);
        doc.setFontSize(size);
        doc.setTextColor(...color);
        const lines = doc.splitTextToSize(text, maxWidth - indent);
        lines.forEach(txt => {
          ensurePage(lineH);
          doc.text(txt, margin + indent, y);
          y += lineH;
        });
      };
      // Header sezione dati
      doc.setFillColor(...colors.section);
      doc.rect(margin, y, maxWidth, 36, "F");
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text("Test su " + topicLabel, margin + 2, y + 8);
      doc.setFontSize(11);
      doc.text("Studente: " + studentLabel, margin + 2, y + 15);
      doc.text("Materia: " + materiaLabel, margin + 2, y + 21);
      doc.text("Classe: " + classeLabel, margin + 2, y + 27);
      doc.text("Data: " + generatedDate, margin + 2, y + 33);
      y += 44;

      doc.setFontSize(11);
      allQuestions.forEach((q, idx) => {
        const questionText = (idx + 1) + ". " + q.question;
        const optionsLines = q.open ? [] : (q.options || []).map((opt, i) => {
          const text = (typeof opt === "string") ? opt : (opt.t || opt.text || opt.testo || opt.label || "");
          return letter(i) + ". " + text;
        });
        const userIdx = answers[q.qid];
        const userLetter = q.open ? "" : (userIdx != null ? letter((q.options || []).findIndex(o => o.id === userIdx)) : "-");
        const correctIdx = q.open ? null : (q.options || []).findIndex(o => hashJoin(q.qid, o.id) === q.correctHash);
        const correctLetter = q.open ? "" : (Number.isInteger(correctIdx) ? letter(correctIdx) : "-");
        const correctOpt = (!q.open && Number.isInteger(correctIdx)) ? (q.options || [])[correctIdx] : null;
        const correctText = correctOpt ? (correctOpt.t || correctOpt.text || correctOpt.testo || correctOpt.label || "") : "";
        const correctLine = q.open ? "" : (correctText ? (correctLetter + ". " + correctText) : correctLetter);

        let blockHeight = doc.splitTextToSize(questionText, maxWidth).length * lineH;
        blockHeight += optionsLines.length * lineH;
        if (!q.open) blockHeight += lineH * 2; // hai risposto + corretta
        if (q.open) blockHeight += doc.splitTextToSize("Risposta: " + (answers[q.qid] || ""), maxWidth).length * lineH;
        blockHeight += lineH * 2;
        ensurePage(blockHeight);

        writeLines(questionText, { font: "bold" });
        if (q.open) {
          const ans = answers[q.qid] || '';
          writeLines("Risposta: " + ans, { indent: 2 });
          writeLines("Domanda aperta - da correggere manualmente.", { indent: 2, color: [90,90,90] });
        } else {
          optionsLines.forEach(line => writeLines(line, { indent: 2 }));
          writeLines("Hai risposto: " + userLetter, { indent: 2 });
          const isCorrect = userIdx != null && Number.isInteger(correctIdx) && (q.options || [])[correctIdx]?.id === userIdx;
          writeLines("Risposta corretta: " + correctLine, { indent: 2, color: isCorrect ? [0,128,0] : [200,0,0] });
        }
        ensurePage(8);
        doc.setDrawColor(...colors.section);
        doc.line(margin, y, margin + maxWidth, y);
        y += 6;
      });

      const closedQuestions = allQuestions.filter(q => !q.open);
      const totalClosed = closedQuestions.length;
      const correctClosed = closedQuestions.reduce((acc, q) => {
        const correctIdx = (q.options || []).findIndex(o => hashJoin(q.qid, o.id) === q.correctHash);
        return acc + ((answers[q.qid] != null && Number.isInteger(correctIdx) && (q.options || [])[correctIdx]?.id === answers[q.qid]) ? 1 : 0);
      }, 0);
      ensurePage(14);
      doc.setFillColor(...colors.section);
      doc.rect(margin, y, maxWidth, 16, "F");
      doc.setFont("helvetica", "bold");
      doc.setFontSize(11);
      doc.text("Totale risposte corrette: " + correctClosed + "/" + totalClosed, margin + 2, y + 7);
      if (totalClosed > 0) {
        const voto = (correctClosed / totalClosed * 10).toFixed(1);
        doc.text("Voto: " + voto, margin + 2, y + 13);
      }

      return doc.output("blob");
    }

    function buildJsonPayload() {
      const letter = (i) => String.fromCharCode(65 + i);
      const payloadDomande = allQuestions.map((q, idx) => {
        if (q.open) {
          return {
            tipo: "aperta",
            domanda: q.question,
            risposta: answers[q.qid] || ""
          };
        }
        const opts = (q.options || []).map((o, i) => ({
          id: o.id,
          testo: o.t,
          lettera: letter(i)
        }));
        const correctHash = q.correctHash;
        const userId = answers[q.qid];
        const correctOpt = opts.find(o => hashJoin(q.qid, o.id) === correctHash);
        const userOpt = opts.find(o => o.id === userId);
        return {
          tipo: "chiusa",
          domanda: q.question,
          opzioni: opts,
          risposta_corretta: correctOpt ? (correctOpt.lettera + ". " + correctOpt.testo) : "",
          risposta_data: userOpt ? (userOpt.lettera + ". " + userOpt.testo) : ""
        };
      });
      const out = {
        studente: studentLabel,
        classe: classeLabel,
        materia: materiaLabel,
        argomento: topicLabel,
        data: generatedDate,
        domande: payloadDomande
      };
      return out;
    }

    function buildJsonBlob() {
      const out = buildJsonPayload();
      return new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
    }

    function buildBaseName() {
      const parts = ["quiz", studentReg, studentSurname, studentName, topicLabel]
        .map(safeName)
        .filter(Boolean);
      return parts.join("_");
    }

    async function writeFileToDir(dirHandle, fileName, blob) {
      const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(blob);
      await writable.close();
    }

    function triggerDownload(blob, name) {
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = name;
      link.click();
      URL.revokeObjectURL(link.href);
    }

    function downloadFilesFallback(baseName, pdfBlob, jsonBlob) {
      triggerDownload(pdfBlob, baseName + ".pdf");
      triggerDownload(jsonBlob, baseName + ".json");
      downloadStatus.textContent = "File salvati nei download.";
      downloadedFiles = true;
      if (downloadedFiles) setTimeout(() => window.close(), 300);
    }

    async function saveResultsFolder() {
      const pdfBlob = buildPdfBlob();
      if (!pdfBlob) return;
      const jsonBlob = buildJsonBlob();
      const baseName = buildBaseName();
      if ("showDirectoryPicker" in window) {
        try {
          const root = await window.showDirectoryPicker();
          const folderHandle = await root.getDirectoryHandle(baseName, { create: true });
          await writeFileToDir(folderHandle, baseName + ".pdf", pdfBlob);
          await writeFileToDir(folderHandle, baseName + ".json", jsonBlob);
          downloadStatus.textContent = "Cartella salvata.";
          downloadedFiles = true;
          if (downloadedFiles) setTimeout(() => window.close(), 300);
          return;
        } catch (err) {
          if (err && err.name === "AbortError") {
            downloadStatus.textContent = "Salvataggio annullato.";
            return;
          }
        }
      }
      downloadFilesFallback(baseName, pdfBlob, jsonBlob);
    }

    
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyVitT9nKPiBk5UAS5CXQep-8JFvmO9MWgLwcfnoeJPt98jo6FOELCLat_Ebz0wNg8/exec";
    const PIN = "PIN123";

    async function consegnaQuiz(quizJson, quizId, studente) {
      const payload = {
        pin: PIN,
        quiz_id: quizId,
        studente: studente,
        payload: quizJson
      };
      const body = new URLSearchParams();
      body.set("data", JSON.stringify(payload));
      const res = await fetch(WEBAPP_URL, { method: "POST", body });
      const text = await res.text();
      console.log("Server:", text);
      alert("Consegna inviata!");
    }

    async function submitDelivery() {
      try {
        const quizJson = buildJsonPayload();
        const quizId = "illuminazione_01";
        const studente = new URLSearchParams(location.search).get("token") || "anonimo";
        await consegnaQuiz(quizJson, quizId, studente);
        downloadStatus.textContent = "Consegna inviata.";
      } catch (err) {
        console.error(err);
        downloadStatus.textContent = "Errore invio consegna.";
      }
    }
    

    let fullscreenWarned = false;
    document.addEventListener('fullscreenchange', () => {
      const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
      if (!isFs) {
        setTimeout(requestFull, 0);
        if (!fullscreenWarned) {
          fullscreenWarned = true;
          alert("Non rimuovere la modalit? Fullscreen, alla prossima consegnerai il compito.");
        } else {
          finishQuiz();
        }
      }
    });

    window.addEventListener('load', () => {
      requestFull();
    });
  </script>
</body>
</html>