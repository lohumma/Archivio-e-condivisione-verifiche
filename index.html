<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>StudHub</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #0b1a2c;
      --card: #10243f;
      --accent: #2dd4bf;
      --accent-strong: #0ea5e9;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: #1f2a44;
      --shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: radial-gradient(120% 120% at 20% 20%, #163355, #0f172a 45%);
      min-height: 100vh;
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 36px;
    }
    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 18px;
      align-items: start;
    }
    .side-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .side-actions .btn {
      width: 100%;
      padding: 14px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #0f2038;
      color: var(--text);
      font-weight: 700;
      cursor: pointer;
      text-align: left;
    }
    .side-actions .btn.active {
      border-color: rgba(14,165,233,0.4);
      box-shadow: 0 0 0 2px rgba(14,165,233,0.15) inset;
      background: #102a4a;
    }
    .panel.light {
      background: #132d4f;
      border-color: #284066;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      font-weight: 700;
      color: #f8fafc;
      letter-spacing: 0.4px;
    }
    .subtitle {
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 18px;
    }
    .panel {
      position: relative;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .toolbar {
      display: grid;
      grid-template-columns: 1.2fr 0.8fr 0.8fr 1.2fr 1.4fr;
      gap: 12px;
      align-items: end;
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select {
      width: 100%;
      padding: 12px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #0f2038;
      color: var(--text);
      font-size: 14px;
    }
    .status {
      margin: 12px 0 18px;
      color: var(--muted);
      font-size: 13px;
    }
    .link-action {
      color: var(--accent);
      cursor: pointer;
      text-decoration: underline;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #0f1e34;
      color: var(--muted);
      font-weight: 600;
    }
    tr:last-child td { border-bottom: none; }
    .hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .link-action.inline-link {
      font-size: 13px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
      .toolbar {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>StudHub</h1>
    <div class="subtitle">Filtro rapido e apertura quiz per studente.</div>
    <div class="layout">
      <div class="side-actions">
        <button class="btn active" id="tab-start">Inizia test</button>
        <button class="btn" id="tab-feedback">Visualizza feedback</button>
      </div>
      <div>
        <div class="panel" id="panel-test">
      <div class="toolbar">
        <div>
          <label>Materia</label>
          <select id="filter-subject"></select>
        </div>
        <div>
          <label>Classe</label>
          <select id="filter-class"></select>
        </div>
        <div>
          <label>Sezione</label>
          <select id="filter-section"></select>
        </div>
        <div>
          <label>Studente</label>
          <select id="filter-student"></select>
        </div>
        <div>
          <label>Argomento</label>
          <select id="filter-topic"></select>
        </div>
      </div>

      <div class="status" id="status">
        Caricamento elenco quiz da GitHub... <span class="link-action" id="pick-archive">Collega cartella locale</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>N. Registro</th>
            <th>Cognome</th>
            <th>Nome</th>
            <th>Azione</th>
          </tr>
        </thead>
        <tbody id="students-body">
          <tr><td colspan="4">Nessun dato.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="panel light" id="panel-feedback" style="display:none;">
      <div class="toolbar">
        <div>
          <label>Materia</label>
          <select id="fb-subject"></select>
        </div>
        <div>
          <label>Classe</label>
          <select id="fb-class"></select>
        </div>
        <div>
          <label>Sezione</label>
          <select id="fb-section"></select>
        </div>
        <div>
          <label>Studente</label>
          <select id="fb-student"></select>
        </div>
        <div>
          <label>Argomento</label>
          <select id="fb-topic"></select>
        </div>
      </div>

      <div class="status" id="fb-status">
        Caricamento feedback da GitHub...
      </div>

      <table>
        <thead>
          <tr>
            <th>N. Registro</th>
            <th>Cognome</th>
            <th>Nome</th>
            <th>File</th>
          </tr>
        </thead>
        <tbody id="fb-body">
          <tr><td colspan="4">Nessun dato.</td></tr>
        </tbody>
      </table>
    </div>
      </div>
    </div>
  </div>

  <script>
    const subjectSel = document.getElementById("filter-subject");
    const classSel = document.getElementById("filter-class");
    const sectionSel = document.getElementById("filter-section");
    const studentSel = document.getElementById("filter-student");
    const topicSel = document.getElementById("filter-topic");
    const statusEl = document.getElementById("status");
    const studentsBody = document.getElementById("students-body");
    const pickArchiveBtn = document.getElementById("pick-archive");
    let records = [];

    const tabStart = document.getElementById("tab-start");
    const tabFeedback = document.getElementById("tab-feedback");
    const panelTest = document.getElementById("panel-test");
    const panelFeedback = document.getElementById("panel-feedback");

    const fbSubjectSel = document.getElementById("fb-subject");
    const fbClassSel = document.getElementById("fb-class");
    const fbSectionSel = document.getElementById("fb-section");
    const fbStudentSel = document.getElementById("fb-student");
    const fbTopicSel = document.getElementById("fb-topic");
    const fbStatusEl = document.getElementById("fb-status");
    const fbBody = document.getElementById("fb-body");
    let feedbackRecords = [];

    function setActivePanel(which) {
      const isTest = which === "test";
      panelTest.style.display = isTest ? "" : "none";
      panelFeedback.style.display = isTest ? "none" : "";
      tabStart.classList.toggle("active", isTest);
      tabFeedback.classList.toggle("active", !isTest);
    }

    function setOptions(select, values) {
      select.innerHTML = "";
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "Seleziona";
      select.appendChild(opt);
      values.forEach(v => {
        const o = document.createElement("option");
        const value = typeof v === "string" ? v : v.value;
        const label = typeof v === "string" ? v : v.label;
        o.value = value;
        o.textContent = label;
        select.appendChild(o);
      });
    }

    function parseStudentLabel(label) {
      const parts = String(label || "").trim().split(/\s+/).filter(Boolean);
      let reg = "";
      if (parts[0] && /^\d+$/.test(parts[0])) reg = parts.shift();
      const surname = parts.shift() || "";
      const given = parts.join(" ") || "";
      return { reg, surname, name: given };
    }

    function parseClassLabel(label) {
      const parts = String(label || "").trim().split(/\s+/).filter(Boolean);
      const classe = parts.shift() || "";
      const sezione = parts.join(" ") || "";
      return { classe, sezione };
    }

    function readConstValue(text, name) {
      const re = new RegExp("const\\s+" + name + "\\s*=\\s*[\"']([^\"']+)[\"']");
      const m = text.match(re);
      return m ? m[1] : "";
    }

    function parseQuizFromHtml(text) {
      const materia = readConstValue(text, "materiaLabel");
      const classeLabel = readConstValue(text, "classeLabel");
      const topic = readConstValue(text, "topicLabel");
      const studLabel = readConstValue(text, "studentLabel");
      if (!materia || !classeLabel || !topic || !studLabel) return null;
      const stud = parseStudentLabel(studLabel);
      const cls = parseClassLabel(classeLabel);
      return {
        subject: materia,
        className: cls.classe,
        section: cls.sezione,
        topic,
        studentKey: studLabel.trim(),
        reg: stud.reg,
        surname: stud.surname,
        name: stud.name
      };
    }

    function parseFeedbackFromPath(path) {
      const parts = String(path || "").split("/");
      const fileName = parts[parts.length - 1] || "";
      const folder = parts[parts.length - 2] || "";
      let subject = "";
      let className = "";
      let section = "";
      let topic = "";
      if (folder.toLowerCase().startsWith("consegna-feed-online_")) {
        const rest = folder.slice("consegna-feed-online_".length);
        const tokens = rest.split("_").filter(Boolean);
        if (tokens.length >= 3) {
          subject = tokens[0];
          className = tokens[1];
          section = tokens[2];
          topic = tokens.slice(3).join("_") || "";
        } else if (tokens.length) {
          subject = tokens[0];
        }
      }
      let reg = "";
      let surname = "";
      let name = "";
      if (fileName.toLowerCase().startsWith("feed_")) {
        const base = fileName.replace(/\.html$/i, "");
        const tokens = base.split("_").filter(Boolean);
        let idx = 1;
        if (tokens[idx] && /^\d+$/.test(tokens[idx])) {
          reg = tokens[idx];
          idx++;
        }
        const surnameInitial = tokens[idx] || "";
        const nameInitial = tokens[idx + 1] || "";
        surname = surnameInitial;
        name = nameInitial;
        const tail = tokens.slice(idx + 2);
        if (tail.length >= 2) {
          className = className || tail[tail.length - 2];
          section = section || tail[tail.length - 1];
        }
      }
      const studentKey = [reg, surname, name].filter(Boolean).join(" ").trim();
      return { subject, className, section, topic, studentKey, reg, surname, name };
    }

    async function buildIndexFromGithub() {
      const owner = "lohumma";
      const repo = "Archivio-e-condivisione-verifiche";
      const commit = "main";
      const subdir = "Consegna_compiti_in_classe";
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${commit}?recursive=1`;
      const rawBase = `https://raw.githubusercontent.com/${owner}/${repo}/${commit}`;
      const resp = await fetch(apiUrl);
      if (!resp.ok) throw new Error("Fetch GitHub fallita");
      const data = await resp.json();
      const tree = Array.isArray(data.tree) ? data.tree : [];
      const htmlFiles = tree.filter(item =>
        item.type === "blob" &&
        item.path.startsWith(subdir + "/") &&
        item.path.toLowerCase().endsWith(".html") &&
        item.path.toLowerCase().includes("/quiz_")
      );
      const out = [];
      for (const item of htmlFiles) {
        const url = rawBase + "/" + item.path;
        const fileResp = await fetch(url);
        if (!fileResp.ok) continue;
        const text = await fileResp.text();
        const base = parseQuizFromHtml(text);
        if (!base) continue;
        out.push({
          ...base,
          fileUrl: url,
          fileName: item.path.split("/").pop()
        });
      }
      return out;
    }

    async function buildFeedbackIndexFromGithub() {
      const owner = "lohumma";
      const repo = "Archivio-e-condivisione-verifiche";
      const commit = "main";
      const subdir = "Visualizzazione_feedback_online";
      const apiUrl = `https://api.github.com/repos/${owner}/${repo}/git/trees/${commit}?recursive=1`;
      const rawBase = `https://raw.githubusercontent.com/${owner}/${repo}/${commit}`;
      const resp = await fetch(apiUrl);
      if (!resp.ok) throw new Error("Fetch GitHub fallita");
      const data = await resp.json();
      const tree = Array.isArray(data.tree) ? data.tree : [];
      const htmlFiles = tree.filter(item =>
        item.type === "blob" &&
        item.path.toLowerCase().startsWith(subdir.toLowerCase() + "/") &&
        item.path.toLowerCase().endsWith(".html")
      );
      const out = [];
      for (const item of htmlFiles) {
        const url = rawBase + "/" + item.path;
        const fileResp = await fetch(url);
        if (!fileResp.ok) continue;
        const text = await fileResp.text();
        let materia = readConstValue(text, "materiaLabel");
        let classeLabel = readConstValue(text, "classeLabel");
        let topic = readConstValue(text, "topicLabel");
        let studLabel = readConstValue(text, "studentLabel");
        let parsed = null;
        if (!materia || !classeLabel || !topic || !studLabel) {
          parsed = parseFeedbackFromPath(item.path);
          materia = materia || parsed.subject;
          classeLabel = classeLabel || [parsed.className, parsed.section].filter(Boolean).join(" ");
          topic = topic || parsed.topic;
          studLabel = studLabel || parsed.studentKey;
        }
        if (!materia || !classeLabel || !topic || !studLabel) continue;
        const stud = parseStudentLabel(studLabel);
        const cls = parseClassLabel(classeLabel);
        out.push({
          subject: materia,
          className: cls.classe || "",
          section: cls.sezione || "",
          topic,
          studentKey: studLabel.trim(),
          reg: stud.reg,
          surname: stud.surname,
          name: stud.name,
          fileUrl: url,
          fileName: item.path.split("/").pop()
        });
      }
      return out;
    }

    async function walkLocal(dirHandle, list) {
      for await (const entry of dirHandle.values()) {
        if (entry.kind === "file") {
          if (!entry.name.toLowerCase().endsWith(".html")) continue;
          if (!entry.name.toLowerCase().startsWith("quiz_")) continue;
          list.push(entry);
        } else if (entry.kind === "directory") {
          const sub = await dirHandle.getDirectoryHandle(entry.name);
          await walkLocal(sub, list);
        }
      }
    }

    async function buildIndexFromLocal(root) {
      const out = [];
      const list = [];
      await walkLocal(root, list);
      for (const handle of list) {
        const file = await handle.getFile();
        const text = await file.text();
        const base = parseQuizFromHtml(text);
        if (!base) continue;
        out.push({
          ...base,
          fileHandle: handle,
          fileName: handle.name
        });
      }
      return out;
    }

    function updateStudentOptions() {
      const subject = subjectSel.value;
      const className = classSel.value;
      const section = sectionSel.value;
      if (!subject || !className || !section) {
        setOptions(studentSel, []);
        setOptions(topicSel, []);
        return;
      }
      const filtered = records.filter(r =>
        r.subject === subject &&
        r.className === className &&
        r.section === section
      );
      const map = new Map();
      filtered.forEach(r => {
        if (!map.has(r.studentKey)) {
          const label = [r.reg, r.surname, r.name].filter(Boolean).join(" ").trim() || r.studentKey;
          map.set(r.studentKey, label);
        }
      });
      const values = Array.from(map.entries())
        .map(([value, label]) => ({ value, label }))
        .sort((a, b) => a.label.localeCompare(b.label, "it"));
      setOptions(studentSel, values);
      setOptions(topicSel, []);
    }

    function updateTopicOptions() {
      const subject = subjectSel.value;
      const className = classSel.value;
      const section = sectionSel.value;
      const student = studentSel.value;
      if (!subject || !className || !section || !student) {
        setOptions(topicSel, []);
        return;
      }
      const topics = [...new Set(records
        .filter(r =>
          r.subject === subject &&
          r.className === className &&
          r.section === section &&
          r.studentKey === student
        )
        .map(r => r.topic))].sort();
      setOptions(topicSel, topics);
    }

    function applyFilters() {
      const subject = subjectSel.value;
      const className = classSel.value;
      const section = sectionSel.value;
      const student = studentSel.value;
      const topic = topicSel.value;
      if (!subject || !className || !section || !student || !topic) {
        studentsBody.innerHTML = '<tr><td colspan="4">Completa tutti i filtri.</td></tr>';
        return;
      }
      const filtered = records.filter(r =>
        r.subject === subject &&
        r.className === className &&
        r.section === section &&
        r.studentKey === student &&
        r.topic === topic
      );
      const map = new Map();
      filtered.forEach(r => {
        const key = [r.studentKey, r.topic].join("|");
        if (!map.has(key)) {
          map.set(key, { reg: r.reg, surname: r.surname, name: r.name, topic: r.topic, items: [] });
        }
        map.get(key).items.push(r);
      });
      const rows = Array.from(map.values()).map((g, idx) => {
        const btnId = "open-btn-" + idx;
        return `<tr>
          <td>${g.reg || ""}</td>
          <td>${g.surname || ""}</td>
          <td>${g.name || ""}</td>
          <td><a class="link-action inline-link" data-open="${btnId}" href="#">Apri quiz</a></td>
        </tr>`;
      }).join("");
      studentsBody.innerHTML = rows || '<tr><td colspan="4">Nessun quiz trovato.</td></tr>';
      const buttons = studentsBody.querySelectorAll("[data-open]");
      const groups = Array.from(map.values());
      buttons.forEach((btn, i) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          openGroupFiles(groups[i]);
        });
      });
    }

    function updateFeedbackStudentOptions() {
      const subject = fbSubjectSel.value;
      const className = fbClassSel.value;
      const section = fbSectionSel.value;
      if (!subject || !className || !section) {
        setOptions(fbStudentSel, []);
        setOptions(fbTopicSel, []);
        return;
      }
      const filtered = feedbackRecords.filter(r =>
        r.subject === subject &&
        r.className === className &&
        r.section === section
      );
      const map = new Map();
      filtered.forEach(r => {
        if (!map.has(r.studentKey)) {
          const label = [r.reg, r.surname, r.name].filter(Boolean).join(" ").trim() || r.studentKey;
          map.set(r.studentKey, label);
        }
      });
      const values = Array.from(map.entries())
        .map(([value, label]) => ({ value, label }))
        .sort((a, b) => a.label.localeCompare(b.label, "it"));
      setOptions(fbStudentSel, values);
      setOptions(fbTopicSel, []);
    }

    function updateFeedbackTopicOptions() {
      const subject = fbSubjectSel.value;
      const className = fbClassSel.value;
      const section = fbSectionSel.value;
      const student = fbStudentSel.value;
      if (!subject || !className || !section || !student) {
        setOptions(fbTopicSel, []);
        return;
      }
      const topics = [...new Set(feedbackRecords
        .filter(r =>
          r.subject === subject &&
          r.className === className &&
          r.section === section &&
          r.studentKey === student
        )
        .map(r => r.topic))].sort();
      setOptions(fbTopicSel, topics);
    }

    function applyFeedbackFilters() {
      const subject = fbSubjectSel.value;
      const className = fbClassSel.value;
      const section = fbSectionSel.value;
      const student = fbStudentSel.value;
      const topic = fbTopicSel.value;
      if (!subject || !className || !section || !student || !topic) {
        fbBody.innerHTML = '<tr><td colspan="4">Completa tutti i filtri.</td></tr>';
        return;
      }
      const filtered = feedbackRecords.filter(r =>
        r.subject === subject &&
        r.className === className &&
        r.section === section &&
        r.studentKey === student &&
        r.topic === topic
      );
      const rows = filtered.map(f => `
        <tr>
          <td>${f.reg || ""}</td>
          <td>${f.surname || ""}</td>
          <td>${f.name || ""}</td>
          <td><a class="link-action inline-link" href="${f.fileUrl}" target="_blank" rel="noopener">Apri file</a></td>
        </tr>
      `).join("");
      fbBody.innerHTML = rows || '<tr><td colspan="4">Nessun feedback trovato.</td></tr>';
    }

    async function openGroupFiles(group) {
      if (!group || !group.items?.length) return;
      for (const item of group.items) {
        if (item.fileUrl) {
          const link = document.createElement("a");
          link.href = "https://htmlpreview.github.io/?" + encodeURIComponent(item.fileUrl);
          link.target = "_blank";
          link.rel = "noopener";
          link.click();
          continue;
        }
        if (item.fileHandle) {
          const file = await item.fileHandle.getFile();
          const url = URL.createObjectURL(file);
          const link = document.createElement("a");
          link.href = url;
          link.target = "_blank";
          link.rel = "noopener";
          link.click();
          setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
      }
    }

    async function loadArchive() {
      try {
        statusEl.textContent = "Scarico elenco quiz da GitHub...";
        records = await buildIndexFromGithub();
        const subjects = [...new Set(records.map(r => r.subject))].sort();
        const classes = [...new Set(records.map(r => r.className))].sort();
        const sections = [...new Set(records.map(r => r.section))].sort();
        setOptions(subjectSel, subjects);
        setOptions(classSel, classes);
        setOptions(sectionSel, sections);
        setOptions(studentSel, []);
        setOptions(topicSel, []);
        statusEl.textContent = `Quiz trovati: ${records.length}. Puoi anche collegare una cartella locale.`;
        applyFilters();
      } catch (err) {
        statusEl.textContent = "Errore nel caricamento da GitHub.";
      }
    }

    async function loadFeedbackArchive() {
      try {
        fbStatusEl.textContent = "Scarico feedback da GitHub...";
        feedbackRecords = await buildFeedbackIndexFromGithub();
        const subjects = [...new Set(feedbackRecords.map(r => r.subject))].sort();
        const classes = [...new Set(feedbackRecords.map(r => r.className))].sort();
        const sections = [...new Set(feedbackRecords.map(r => r.section))].sort();
        setOptions(fbSubjectSel, subjects);
        setOptions(fbClassSel, classes);
        setOptions(fbSectionSel, sections);
        setOptions(fbStudentSel, []);
        setOptions(fbTopicSel, []);
        fbStatusEl.textContent = `Feedback trovati: ${feedbackRecords.length}.`;
        applyFeedbackFilters();
      } catch (err) {
        fbStatusEl.textContent = "Errore nel caricamento feedback da GitHub.";
      }
    }

    [subjectSel, classSel, sectionSel].forEach(sel => {
      sel.addEventListener("change", () => {
        updateStudentOptions();
        applyFilters();
      });
    });
    studentSel.addEventListener("change", () => {
      updateTopicOptions();
      applyFilters();
    });
    topicSel.addEventListener("change", applyFilters);
    if (pickArchiveBtn) {
      pickArchiveBtn.addEventListener("click", async () => {
        if (!("showDirectoryPicker" in window)) {
          statusEl.textContent = "Browser non supporta l'accesso alle cartelle locali.";
          return;
        }
        try {
          let root = await window.showDirectoryPicker();
          if (root.name !== "Consegna_compiti_in_classe") {
            root = await root.getDirectoryHandle("Consegna_compiti_in_classe");
          }
          statusEl.textContent = "Caricamento quiz locali...";
          const localRecords = await buildIndexFromLocal(root);
          records = records.concat(localRecords);
          const subjects = [...new Set(records.map(r => r.subject))].sort();
          const classes = [...new Set(records.map(r => r.className))].sort();
          const sections = [...new Set(records.map(r => r.section))].sort();
          setOptions(subjectSel, subjects);
          setOptions(classSel, classes);
          setOptions(sectionSel, sections);
          setOptions(studentSel, []);
          setOptions(topicSel, []);
          statusEl.textContent = `Quiz trovati: ${records.length}.`;
          applyFilters();
        } catch (err) {
          statusEl.textContent = "Selezione cartella locale annullata.";
        }
      });
    }
    if (tabStart) tabStart.addEventListener("click", () => setActivePanel("test"));
    if (tabFeedback) tabFeedback.addEventListener("click", () => setActivePanel("feedback"));

    [fbSubjectSel, fbClassSel, fbSectionSel].forEach(sel => {
      sel.addEventListener("change", () => {
        updateFeedbackStudentOptions();
        applyFeedbackFilters();
      });
    });
    fbStudentSel.addEventListener("change", () => {
      updateFeedbackTopicOptions();
      applyFeedbackFilters();
    });
    fbTopicSel.addEventListener("change", applyFeedbackFilters);

    loadArchive();
    loadFeedbackArchive();

  </script>
</body>
</html>
